#!/bin/execlineb -S0
backtick -n __TMPLAUNCHENV { s6-uniquename /tmp/.launch-env }
multisubstitute {
    importas -u TMP __TMPLAUNCHENV
    importas -i USERHOME HOME
    import -uD 1 S6_VERBOSITY
    import -uD /etc/s6-rc S6_CONF_DIR
    import -uD /run/s6-rc S6_RUN_DIR
    import -uD 1000 S6_INIT_TIMEOUT
    import -uD 300000 S6_START_TIMEOUT
    import -uD 5000 S6_STOP_TIMEOUT
}

if { s6-mkdir -p -m 0755 $TMP }
if { s6-dumpenv ${TMP}/env }
if { /libexec/s6-rc/dump-user-env ${TMP}/user }

/libexec/gosu root:root
/bin/export PATH /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin
cd /

define S6_LAUNCH_ENV ${S6_RUN_DIR}/launch

export S6_CONF_DIR $S6_CONF_DIR
export S6_RUN_DIR $S6_RUN_DIR
export S6_INIT_TIMEOUT $S6_INIT_TIMEOUT
export S6_START_TIMEOUT $S6_START_TIMEOUT
export S6_STOP_TIMEOUT $S6_STOP_TIMEOUT
export S6_VERBOSITY $S6_VERBOSITY
export S6_LAUNCH_ENV $S6_LAUNCH_ENV

export S6_COMPILED_DIR ${S6_RUN_DIR}/compiled
export S6_SCAN_DIR ${S6_RUN_DIR}/scandir
export S6_LIVE_DIR ${S6_RUN_DIR}/live

if { /libexec/s6-rc/empty-dir /run }
if { s6-hiercopy $S6_CONF_DIR $S6_RUN_DIR }
if { mv $TMP $S6_LAUNCH_ENV }

if { ln -snf ${S6_LAUNCH_ENV}/env ${USERHOME}/.envdir }
if { s6-dumpenv /root/.envdir }

if { chown -R root:root $S6_LAUNCH_ENV }
if { chmod -R a+rX,go-w $S6_LAUNCH_ENV }

if { /libexec/s6-rc/empty-dir /tmp }
$@
