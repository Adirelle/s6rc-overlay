#!/bin/execlineb -S0
multisubstitute {
    importas -i SCANDIR S6_SCANDIR
    importas -D 0 V S6_VERBOSITY
}

if { s6-rmrf $SCANDIR }
if { s6-hiercopy /etc/s6-rc/scandir $SCANDIR }
if { s6-mkfifo ${SCANDIR}/.s6-svscan/control }

background {
    redirfd -w 3 ${SCANDIR}/.s6-svscan/control
    fdclose 3

    /libexec/s6-rc/collect-exit-code
    s6-notice "Starting services"
    if { s6-rc-init -t 1000 $SCANDIR }
    if { s6-rc -t 300000 -v $V -u change services }
    $@
}
unexport !

redirfd -r 0 /dev/null
s6-notice "Starting service supervisor"
s6-svscan -st0 $SCANDIR
