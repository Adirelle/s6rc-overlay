#!/bin/execlineb
backtick -n __TMPLAUNCHENV {
    s6-uniquename /tmp/.launch-en
}
multisubstitute {
    importas -u TMP __TMPLAUNCHENV
    importas -i USERHOME HOME
    importas -D 1 VERBOSITY S6_VERBOSITY
    importas -uD /etc/s6-rc CONF_DIR S6_CONF_DIR
    importas -uD /run/s6-rc RUN_DIR S6_RUN_DIR
    importas -uD /etc/services.d SERVICES_DIR S6_SERVICES_DIR
    importas -uD 500 INIT_TIMEOUT S6_INIT_TIMEOUT
    importas -uD 120000 START_TIMEOUT S6_START_TIMEOUT
    importas -uD 5000 STOP_TIMEOUT S6_STOP_TIMEOUT
    importas -uD services TARGET S6_TARGET
}
if {
    s6-mkdir -p -m 0755 $TMP
}
if {
    unexport S6_USER
    emptyenv -P
    s6-dumpenv ${TMP}/env
}
if {
    /libexec/s6-rc/dump-user-env ${TMP}/user
}

elgetpositionals

emptyenv
/bin/export PATH /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin

/libexec/su-exec root:root
cd /

export S6_CONF_DIR $CONF_DIR
export S6_RUN_DIR $RUN_DIR
export S6_INIT_TIMEOUT $INIT_TIMEOUT
export S6_START_TIMEOUT $START_TIMEOUT
export S6_STOP_TIMEOUT $STOP_TIMEOUT
export S6_VERBOSITY $VERBOSITY
export S6_TARGET $TARGET
export S6_SERVICES_DIR $SERVICES_DIR

export S6_COMPILED_DIR ${CONF_DIR}/compiled

export S6_LAUNCH_ENV ${RUN_DIR}/launch
export S6_SCAN_DIR ${RUN_DIR}/scandir
export S6_LIVE_DIR ${RUN_DIR}/live

if {
    /libexec/s6-rc/empty-dir /run
}
if {
    importas -i LAUNCH_ENV S6_LAUNCH_ENV

    if {
        s6-hiercopy $CONF_DIR $RUN_DIR
    }
    if {
        mv $TMP $LAUNCH_ENV
    }

    if {
        ln -snf ${LAUNCH_ENV}/env ${USERHOME}/.envdir
    }
    if {
        s6-dumpenv /root/.envdir
    }

    if {
        chown -R root:root $LAUNCH_ENV
    }
    chmod -R a+rX,go-w $LAUNCH_ENV
}
if {
    /libexec/s6-rc/empty-dir /tmp
}

$@
