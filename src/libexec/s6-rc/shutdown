#!/bin/execlineb
importas -i S6_SCAN_DIR S6_SCAN_DIR
cd $S6_SCAN_DIR
if {
    s6-setlock -n .shutdown.lock
    if -n {
        s6-test -e .shutdown
    }
    touch .shutdown
}
backtick -n REASON {
    importas -i SELF 0
    s6-basename $SELF
}
importas -u REASON REASON
s6-notice "Shutting down: ${REASON}"
if {
    multisubstitute {
        importas -i S6_LIVE_DIR S6_LIVE_DIR
        importas -i S6_STOP_TIMEOUT S6_STOP_TIMEOUT
        importas -i S6_VERBOSITY S6_VERBOSITY
    }
    s6-notice "Stopping services"
    s6-rc -l $S6_LIVE_DIR -v $S6_VERBOSITY -t $S6_STOP_TIMEOUT -ad change
}
s6-notice "Services stopped"
s6-notice "Stopping service supervisor"
s6-svscanctl -zst .
